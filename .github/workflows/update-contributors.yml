# SPDX-FileCopyrightText: Copyright (c) 2025 Broadsage <opensource@broadsage.com>
#
# SPDX-License-Identifier: Apache-2.0

name: Update Contributors Statistics

# This workflow uses crazy-max/ghaction-import-gpg for secure GPG key handling
# and automatic commit signing following GitHub Actions best practices

on:
  push:
    branches:
      - main
  schedule:
    - cron: "0 0 * * 0" # Weekly on Sundays at midnight UTC
  workflow_dispatch:

# Enhanced permissions for personal token operations
permissions:
  contents: write
  pull-requests: write

jobs:
  update-contributors:
    runs-on: ubuntu-latest
    # Enhanced permissions for this job to support personal token operations
    permissions:
      contents: write # Required for creating commits and branches
      pull-requests: write # Required for creating pull requests

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # Use opensource-committer GitHub token for git operations
          # Personal token preserves GPG verification chain (GitHub Apps cannot verify human GPG keys)
          # This follows security best practices for automated commits requiring cryptographic verification
          token: ${{ secrets.DEVEX_GITHUB_COMMITTER_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Import GPG key
        id: import-gpg
        uses: crazy-max/ghaction-import-gpg@v6.3.0
        with:
          gpg_private_key: ${{ secrets.DEVEX_GITHUB_GPG_PRIVATE_KEY }}
          passphrase: ${{ secrets.DEVEX_GITHUB_GPG_PASSPHRASE }}
          git_user_signingkey: true
          git_commit_gpgsign: true
          git_config_global: false
          trust_level: 5

      - name: Configure Git
        run: |
          git config --local user.email "opensource-committer@broadsage.com"
          git config --local user.name "opensource-committer"
          echo "‚úÖ Git configuration completed"
          echo "Using opensource-committer authentication for enhanced permissions"

      - name: Update contributor statistics
        run: python scripts/update-contributors.py

      - name: Check for changes
        id: verify-changed-files
        run: |
          if git diff --exit-code --quiet CONTRIBUTORS.md; then
            echo "No changes detected"
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "Changes detected"
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Configure Git authentication
        if: steps.verify-changed-files.outputs.changed == 'true'
        run: |
          # Configure Git remote to use opensource-committer token for push operations
          # This provides enhanced permissions while preserving GPG signing
          git remote set-url origin "https://x-access-token:${{ secrets.DEVEX_GITHUB_COMMITTER_TOKEN }}@github.com/${{ github.repository }}.git"
          echo "‚úÖ Configured opensource-committer token for repository operations"

      - name: Commit changes
        if: steps.verify-changed-files.outputs.changed == 'true'
        run: |
          echo "üìù Creating GPG-signed commit..."

          # Add changed files
          git add CONTRIBUTORS.md

          # Prepare commit message
          COMMIT_MSG="docs(contributors): update dynamic statistics [automated]

          - Updated contributor counts and percentages
          - Refreshed monthly statistics
          - Updated recent activity summary

          Generated by: ${{ github.workflow }} workflow

          Signed-off-by: opensource-committer <opensource-committer@broadsage.com>"

          # Create GPG-signed commit (signing is automatically configured by ghaction-import-gpg)
          git commit -m "$COMMIT_MSG" --signoff

          # Show commit details
          echo "üìã Commit details:"
          git log --pretty=format:"%h %s %G?" -1
          echo ""
          echo "‚úÖ GPG-signed commit created successfully"

      - name: Create Pull Request
        if: steps.verify-changed-files.outputs.changed == 'true'
        id: create-pr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.DEVEX_GITHUB_COMMITTER_TOKEN }}
          title: "üìä Update Contributors Statistics"
          body: |
            ## üìä Automated Contributors Statistics Update

            This PR contains automated updates to the contributors statistics based on the latest repository activity.

            ### üîÑ Changes Made:
            - ‚úÖ Updated contributor counts and percentages
            - ‚úÖ Refreshed monthly statistics highlights
            - ‚úÖ Updated recent activity summary
            - ‚úÖ Recalculated contribution type breakdowns

            ### üìä Statistics Updated:
            - Total contributors count
            - Code contributors percentage
            - Documentation contributors percentage  
            - Bug fixers and feature contributors
            - Monthly activity metrics

            ### ü§ñ Automation Details:
            - **Generated by:** `${{ github.workflow }}` workflow
            - **Triggered by:** ${{ github.event_name }}
            - **Branch:** ${{ github.ref_name }}
            - **Commit:** ${{ github.sha }}

            ### ‚úÖ Compliance:
            - **DCO Signed-off:** Yes (automated)
            - **Commit Author:** opensource-committer
            - **GPG Signed:** Yes (verified commits using crazy-max/ghaction-import-gpg)
            - **Authentication:** opensource-committer GitHub token
            - **Security:** Enhanced permissions with preserved verification

            ---

            > This is an automated PR. Please review the changes and merge if everything looks correct.
          branch: contributors/update-stats-${{ github.run_number }}
          base: main
          delete-branch: true
          labels: |
            documentation
            automated
            contributors
          assignees: |
            ${{ github.actor }}
          draft: false

      - name: Trigger status checks
        if: steps.verify-changed-files.outputs.changed == 'true' && steps.create-pr.outputs.pull-request-number
        env:
          GH_TOKEN: ${{ secrets.DEVEX_GITHUB_COMMITTER_TOKEN }}
        run: |
          echo "PR created: #${{ steps.create-pr.outputs.pull-request-number }}"
          echo "PR URL: ${{ steps.create-pr.outputs.pull-request-url }}"

          # Close and reopen the PR to trigger status checks
          echo "Triggering status checks via close/reopen method..."
          gh pr close ${{ steps.create-pr.outputs.pull-request-number }} --comment "**System Notice:** Temporarily closing PR to initialize required branch protection checks and compliance validations."
          sleep 2
          gh pr reopen ${{ steps.create-pr.outputs.pull-request-number }} --comment "**System Notice:** Reopening PR to activate enterprise compliance workflows and mandatory status checks required for merge approval. All configured branch protection rules and quality gates are now active."

          echo "‚úÖ Status checks triggered successfully"

      - name: Summary
        if: steps.verify-changed-files.outputs.changed == 'true'
        run: |
          {
            echo "## üìä Contributors Statistics Updated Successfully"
            echo ""
            echo "A Pull Request has been automatically created with updated contributor statistics."
            echo ""
            echo "### üîÑ Changes Made:"
            echo "- ‚úÖ Updated contributor counts and percentages"
            echo "- ‚úÖ Refreshed monthly statistics highlights"
            echo "- ‚úÖ Updated recent activity summary"
            echo "- ‚úÖ Recalculated contribution type breakdowns"
            echo ""
            echo "### üìã Next Steps:"
            echo "1. Review the created Pull Request"
            echo "2. Status checks should now be running automatically"
            echo "3. Verify the statistical updates are accurate"
            echo "4. Merge the PR to apply the changes"
            echo ""
            if [ -n "${{ steps.create-pr.outputs.pull-request-number }}" ]; then
              echo "üîó **PR #${{ steps.create-pr.outputs.pull-request-number }}:** ${{ steps.create-pr.outputs.pull-request-url }}"
            fi
            echo ""
            echo "‚úÖ **Status Checks:** Automatically triggered via close/reopen method"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: No changes summary
        if: steps.verify-changed-files.outputs.changed == 'false'
        run: |
          echo "## üìä No Updates Required" >> "$GITHUB_STEP_SUMMARY"
          echo "The contributor statistics are already up to date." >> "$GITHUB_STEP_SUMMARY"
