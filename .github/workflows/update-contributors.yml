# SPDX-FileCopyrightText: Copyright (c) 2025 Broadsage <opensource@broadsage.com>
# SPDX-License-Identifier: Apache-2.0

---
name: Update Contributors Statistics

on:
  schedule:
    # Run daily at 6 AM UTC
    - cron: "0 6 * * *"
  workflow_dispatch:
    # Allow manual triggering
  push:
    branches: [develop]
    paths:
      - ".github/workflows/update-contributors.yml"

permissions: read-all

jobs:
  update-contributors:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@ec9f2d5744a09debf3a187a3f4f675c53b671911 # v2.13.0
        with:
          egress-policy: audit

      - name: Checkout repository
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0
        with:
          fetch-depth: 0 # Fetch full history for accurate statistics
          token: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
          persist-credentials: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Configure Git
        run: |
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

      - name: Update contributor statistics
        run: python scripts/update-contributors.py

      - name: Check for changes
        id: verify-changed-files
        run: |
          if git diff --exit-code --quiet CONTRIBUTORS.md; then
            echo "No changes detected"
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "Changes detected"
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Create Pull Request
        if: steps.verify-changed-files.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            docs(contributors): update dynamic statistics [automated]
            
            - Updated contributor counts and percentages
            - Refreshed monthly statistics
            - Updated recent activity summary
            
            Generated by: ${{ github.workflow }} workflow
          title: "ðŸ“Š Update Contributors Statistics"
          body: |
            ## ðŸ“Š Automated Contributors Statistics Update
            
            This PR contains automated updates to the contributors statistics based on the latest repository activity.
            
            ### ðŸ”„ Changes Made:
            - âœ… Updated contributor counts and percentages
            - âœ… Refreshed monthly statistics highlights
            - âœ… Updated recent activity summary
            - âœ… Recalculated contribution type breakdowns
            
            ### ðŸ“Š Statistics Updated:
            - Total contributors count
            - Code contributors percentage
            - Documentation contributors percentage  
            - Bug fixers and feature contributors
            - Monthly activity metrics
            
            ### ðŸ¤– Automation Details:
            - **Generated by:** `${{ github.workflow }}` workflow
            - **Triggered by:** ${{ github.event_name }}
            - **Branch:** ${{ github.ref_name }}
            - **Commit:** ${{ github.sha }}
            
            ---
            
            > This is an automated PR. Please review the changes and merge if everything looks correct.
          branch: contributors/update-stats-${{ github.run_number }}
          base: main
          delete-branch: true
          labels: |
            documentation
            automated
            contributors
          assignees: |
            ${{ github.actor }}
          draft: false

      - name: Create summary
        if: steps.verify-changed-files.outputs.changed == 'true'
        run: |
          {
            echo "## ðŸ“Š Contributors Statistics PR Created"
            echo "A Pull Request has been automatically created with updated contributor statistics."
            echo ""
            echo "### ðŸ”„ Changes Made:"
            echo "- âœ… Updated contributor counts and percentages"
            echo "- âœ… Refreshed monthly statistics highlights"
            echo "- âœ… Updated recent activity summary"
            echo "- âœ… Recalculated contribution type breakdowns"
            echo ""
            echo "### ðŸ“‹ Next Steps:"
            echo "1. Review the created Pull Request"
            echo "2. Verify the statistical updates are accurate"
            echo "3. Merge the PR to apply the changes"
            echo ""
            echo "ðŸ”— **PR Link:** Will be available in the workflow summary"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: No changes summary
        if: steps.verify-changed-files.outputs.changed == 'false'
        run: |
          echo "## ðŸ“Š No Updates Required" >> "$GITHUB_STEP_SUMMARY"
          echo "The contributor statistics are already up to date." >> "$GITHUB_STEP_SUMMARY"
