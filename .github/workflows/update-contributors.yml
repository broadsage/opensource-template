# SPDX-FileCopyrightText: Copyright (c) 2025 Broadsage <opensource@broadsage.com>
# SPDX-License-Identifier: Apache-2.0

---
name: Update Contributors Statistics

on:
  schedule:
    # Run daily at 6 AM UTC
    - cron: "0 6 * * *"
  workflow_dispatch:
    # Allow manual triggering
  push:
    branches: [develop]
    paths:
      - ".github/workflows/update-contributors.yml"

permissions: read-all

jobs:
  update-contributors:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@ec9f2d5744a09debf3a187a3f4f675c53b671911 # v2.13.0
        with:
          egress-policy: audit

      - name: Checkout repository
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0
        with:
          fetch-depth: 0 # Fetch full history for accurate statistics
          token: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
          persist-credentials: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Configure Git
        run: |
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

      - name: Update contributor statistics
        run: python scripts/update-contributors.py

      - name: Check for changes
        id: verify-changed-files
        run: |
          if git diff --exit-code --quiet CONTRIBUTORS.md; then
            echo "No changes detected"
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "Changes detected"
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit and push changes
        if: steps.verify-changed-files.outputs.changed == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          git add CONTRIBUTORS.md
          git commit -m "docs(contributors): update dynamic statistics [automated]

          - Updated contributor counts and percentages
          - Refreshed monthly statistics
          - Updated recent activity summary

          Generated by: ${{ github.workflow }} workflow"
          git push origin HEAD:${{ github.ref_name }}

      - name: Create summary
        if: steps.verify-changed-files.outputs.changed == 'true'
        run: |
          {
            echo "## ðŸ“Š Contributors Statistics Updated"
            echo "The CONTRIBUTORS.md file has been automatically updated with the latest statistics."
            echo ""
            echo "### Changes Made:"
            echo "- âœ… Updated contributor counts"
            echo "- âœ… Refreshed percentage calculations"
            echo "- âœ… Updated monthly highlights"
            echo "- âœ… Refreshed recent activity summary"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: No changes summary
        if: steps.verify-changed-files.outputs.changed == 'false'
        run: |
          echo "## ðŸ“Š No Updates Required" >> "$GITHUB_STEP_SUMMARY"
          echo "The contributor statistics are already up to date." >> "$GITHUB_STEP_SUMMARY"
