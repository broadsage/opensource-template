# SPDX-FileCopyrightText: Copyright (c) 2025 Broadsage <opensource@broadsage.com>
# SPDX-License-Identifier: Apache-2.0

---
name: Update Contributors Statistics

on:
  schedule:
    # Run daily at 6 AM UTC
    - cron: "0 6 * * *"
  workflow_dispatch:
    # Allow manual triggering
  push:
    branches: [develop]
    paths:
      - ".github/workflows/update-contributors.yml"

permissions: read-all

jobs:
  update-contributors:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@ec9f2d5744a09debf3a187a3f4f675c53b671911 # v2.13.0
        with:
          egress-policy: audit

      - name: Checkout repository
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0
        with:
          fetch-depth: 0 # Fetch full history for accurate statistics
          token: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
          persist-credentials: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Configure Git
        run: |
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

      - name: Update contributor statistics
        run: python scripts/update-contributors.py

      - name: Check for changes
        id: verify-changed-files
        run: |
          if git diff --exit-code --quiet CONTRIBUTORS.md; then
            echo "No changes detected"
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "Changes detected"
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Create Pull Request
        if: steps.verify-changed-files.outputs.changed == 'true'
        id: create-pr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
          commit-message: |
            docs(contributors): update dynamic statistics [automated]
            
            - Updated contributor counts and percentages
            - Refreshed monthly statistics
            - Updated recent activity summary
            
            Generated by: ${{ github.workflow }} workflow
          title: "ðŸ“Š Update Contributors Statistics"
          body: |
            ## ðŸ“Š Automated Contributors Statistics Update
            
            This PR contains automated updates to the contributors statistics based on the latest repository activity.
            
            ### ðŸ”„ Changes Made:
            - âœ… Updated contributor counts and percentages
            - âœ… Refreshed monthly statistics highlights
            - âœ… Updated recent activity summary
            - âœ… Recalculated contribution type breakdowns
            
            ### ðŸ“Š Statistics Updated:
            - Total contributors count
            - Code contributors percentage
            - Documentation contributors percentage  
            - Bug fixers and feature contributors
            - Monthly activity metrics
            
            ### ðŸ¤– Automation Details:
            - **Generated by:** `${{ github.workflow }}` workflow
            - **Triggered by:** ${{ github.event_name }}
            - **Branch:** ${{ github.ref_name }}
            - **Commit:** ${{ github.sha }}
            
            ---
            
            > This is an automated PR. Please review the changes and merge if everything looks correct.
          branch: contributors/update-stats-${{ github.run_number }}
          base: main
          delete-branch: true
          labels: |
            documentation
            automated
            contributors
          assignees: |
            ${{ github.actor }}
          draft: false

      - name: Trigger status checks
        if: steps.verify-changed-files.outputs.changed == 'true' && steps.create-pr.outputs.pull-request-number
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          echo "PR created: #${{ steps.create-pr.outputs.pull-request-number }}"
          echo "PR URL: ${{ steps.create-pr.outputs.pull-request-url }}"
          
          # Simple and reliable method: Close and reopen the PR to trigger workflows
          echo "Triggering status checks by closing and reopening PR..."
          
          # Wait a moment for PR to be fully created
          sleep 3
          
          # Close the PR
          gh pr close ${{ steps.create-pr.outputs.pull-request-number }} --comment "ðŸ”„ Temporarily closing to trigger status checks..."
          
          # Wait a moment
          sleep 2
          
          # Reopen the PR
          gh pr reopen ${{ steps.create-pr.outputs.pull-request-number }} --comment "âœ… Reopened - status checks should now be triggered automatically!"
          
          echo "PR has been closed and reopened to trigger status checks."
          
          # Additional check: verify the PR is open
          PR_STATE=$(gh pr view ${{ steps.create-pr.outputs.pull-request-number }} --json state --jq '.state')
          echo "PR state after reopen: $PR_STATE"
          
          if [ "$PR_STATE" = "OPEN" ]; then
            echo "âœ… PR is open and status checks should be running"
          else
            echo "âš ï¸ PR state is unexpected: $PR_STATE"
          fi

      - name: Create summary
        if: steps.verify-changed-files.outputs.changed == 'true'
        run: |
          {
            echo "## ðŸ“Š Contributors Statistics PR Created"
            echo "A Pull Request has been automatically created with updated contributor statistics."
            echo ""
            echo "### ðŸ”„ Changes Made:"
            echo "- âœ… Updated contributor counts and percentages"
            echo "- âœ… Refreshed monthly statistics highlights"
            echo "- âœ… Updated recent activity summary"
            echo "- âœ… Recalculated contribution type breakdowns"
            echo ""
            echo "### ðŸ“‹ Next Steps:"
            echo "1. Review the created Pull Request"
            echo "2. Status checks should now be running automatically"
            echo "3. Verify the statistical updates are accurate"
            echo "4. Merge the PR to apply the changes"
            echo ""
            if [ -n "${{ steps.create-pr.outputs.pull-request-number }}" ]; then
              echo "ðŸ”— **PR #${{ steps.create-pr.outputs.pull-request-number }}:** ${{ steps.create-pr.outputs.pull-request-url }}"
            fi
            echo ""
            echo "âœ… **Status Checks:** Automatically triggered via close/reopen method"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: No changes summary
        if: steps.verify-changed-files.outputs.changed == 'false'
        run: |
          echo "## ðŸ“Š No Updates Required" >> "$GITHUB_STEP_SUMMARY"
          echo "The contributor statistics are already up to date." >> "$GITHUB_STEP_SUMMARY"
